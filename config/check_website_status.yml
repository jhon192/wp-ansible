---
- name: Diagnóstico de Apache en localhost
  hosts: localhost
  become: true
  gather_facts: false
  vars:
    ansible_remote_tmp: "/tmp/.ansible-123324453"
  tasks:

  - name: Validar que las directivas 'Require' estén dentro de bloques válidos
    shell: |
      awk '/Require / && !in_block { print "Línea inválida:", NR, $0 } 
          /<Directory|<Location|<Files|<Proxy/ { in_block=1 } 
          /<\/Directory>|<\/Location>|<\/Files>|<\/Proxy>/ { in_block=0 }' /etc/apache2/apache2.conf
    register: require_check

  - name: Mostrar líneas inválidas con Require
    debug:
      var: require_check.stdout_lines
    when: require_check.stdout != ""

  - name: verificar el estado de Apache
    service:
      name: apache2
      state: started
      enabled: true
      
  - name: Ejecutar apachectl configtest
    shell: apachectl configtest
    register: config_test
    ignore_errors: true

  - name: Mostrar resultado del configtest
    debug:
      msg: "{{ config_test.stdout_lines if config_test.rc == 0 else config_test.stderr_lines }}"

