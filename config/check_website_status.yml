- name: Verificar salud de RAM, CPU, Apache y almacenamiento
  hosts: all
  gather_facts: true
  become: true

  vars:
    ansible_remote_tmp: "/tmp/.ansible-123324453"
    ansible_connection: local

  tasks:
    - name: Obtener información de Apache
      ansible.builtin.command: apachectl -S
      register: apachectl_out
      changed_when: false

    - name: Extraer nombres de host únicos
      when: (apache_sites | default([])) | length == 0 and apachectl_out.rc == 0
      set_fact:
        apache_sites: >-
          {{ apachectl_out.stdout_lines
            | select('search', 'namevhost')
            | map('regex_replace', ':\\d+$', '')
            | unique
            | list
          }}

    - name: Mostrar los sitios de Apache encontrados
      debug:
        var: apache_sites

    - name: Mostrar espacio libre por punto de montaje
      ansible.builtin.debug:
        msg: "{{ item.mount }} → {{ item.size_available | filesizeformat(binary=True) }} libres (de {{ item.size_total | filesizeformat(binary=True) }})"
      loop: "{{ ansible_mounts }}"
      loop_control:
        label: "{{ item.mount }}"
      tags: almacenamiento
      ignore_errors: true

    - name: Copiar los últimos 200 líneas del error_log localmente
      ansible.builtin.shell: "tail -n 200 /var/log/apache2/error.log"
      register: errlog
      changed_when: false

    - name: Mostrar el log en pantalla
      ansible.builtin.debug:
        var: errlog.stdout_lines
    - name: Verificar sintaxis antes de reiniciar
      ansible.builtin.command: apache2ctl configtest
      register: apache_configtest
      changed_when: false
      failed_when: apache_configtest.rc != 0

    - name: Recarga elegante de Apache
      ansible.builtin.systemd:
        name: apache2          # httpd en RHEL/CentOS
        state: reloaded        # Usa restarted si prefieres corte completo
      when: apache_configtest.rc == 0
      notify: mostrar_estado


    - name: recargar apache2
      ansible.builtin.command: systemctl reload apache2
      changed_when: false

    - name: (Des)habilitar site example.com
      ansible.builtin.command: a2ensite webmachine.siteffect.com.conf
      
    - name: recargar apache2
      ansible.builtin.command: systemctl reload apache2
      changed_when: false

  handlers:
    - name: mostrar_estado
      ansible.builtin.command: systemctl status --no-pager apache2
      changed_when: false