---
# archivo: verificar_sistema.yml
# Ejecuta: ansible-playbook verificar_sistema.yml -l webservers

- name: Verificar salud de RAM, CPU, Apache y almacenamiento
  hosts: all
  gather_facts: yes
  become: yes                   # necesario para ejecutar apachectl -S

  tasks:
    - name: Obtener información de Apache
      ansible.builtin.command: apachectl -S
      register: apachectl_out
      changed_when: false

    - name: Extraer nombres de host únicos
      when: (apache_sites | default([])) | length == 0 and apachectl_out.rc == 0
      set_fact:
        apache_sites: >-
          {{ apachectl_out.stdout_lines
            | select('search', 'namevhost')
            | map('regex_replace', ':\\d+$', '')
            | unique
            | list
          }}

    - name: Comprobar almacenamiento disponible en servidores Ubuntu
      hosts: ubuntu_servers          # Cambia este grupo por el que uses en tu inventario
      gather_facts: true             # Necesario para obtener ansible_mounts

    - name: Mostrar espacio libre por punto de montaje
      ansible.builtin.debug:
        msg: "{{ item.mount }} ➜ {{ item.size_available | human_readable(size=True, binary=True) }} libres (de {{ item.size_total | human_readable(size=True, binary=True) }})"
      loop: "{{ ansible_mounts }}"
      loop_control:
        label: "{{ item.mount }}"
      tags: almacenamiento  