---
- name: Diagnóstico de Apache en localhost
  hosts: localhost
  become: true
  gather_facts: false
  vars:
    ansible_remote_tmp: "/tmp/.ansible-123324453"
  tasks:

    - name: Verificar estado del servicio Apache
      shell: systemctl status apache2.service -l --no-pager
      register: apache_status
      ignore_errors: true

    - name: Mostrar estado del servicio Apache
      debug:
        var: apache_status.stdout_lines

    - name: Ejecutar apachectl configtest
      shell: apachectl configtest
      register: config_test
      ignore_errors: true

    - name: Mostrar resultado del configtest
      debug:
        msg: "{{ config_test.stdout_lines if config_test.rc == 0 else config_test.stderr_lines }}"

    - name: Mostrar logs de Apache si configtest falla
      shell: journalctl -xeu apache2.service --no-pager | tail -n 50
      register: apache_logs
      when: config_test.rc != 0

    - name: Mostrar últimos logs del servicio apache2
      debug:
        var: apache_logs.stdout_lines
      when: config_test.rc != 0

    - name: Recargar Apache si configtest fue exitoso
      service:
        name: apache2
        state: reloaded
      when: config_test.rc == 0
