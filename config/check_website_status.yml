---
# diagnostico_apache_completo.yml
# Diagnóstico de errores 500 en Apache (sitios bajo /home/semaphore)
# Autor: ChatGPT (o3) — Mayo 2025

- name: Diagnosticar y recopilar evidencias
  hosts: localhost
  become: true
  gather_facts: true

  ######################################################################
  # VARIABLES (ajusta según tu entorno)
  ######################################################################
  vars:
    ansible_remote_tmp: "/tmp/.ansible-123324453"
    ansible_connection: local

    # Nombre de los servicios
    apache_service_name: "{{ 'httpd' if ansible_os_family == 'RedHat' else 'apache2' }}"
    php_fpm_service_name: ""               # '' si no usas PHP-FPM
    vhost_conf_paths:
      - "/etc/apache2/sites-enabled"
      - "/etc/apache2/conf-enabled"
      - "/etc/httpd/conf.d"
    error_log_patterns: "*error*.log"
    lines_to_fetch: 200
    fetch_dest_root: "{{ ansible_env.HOME }}/ansible_logs"   # <— carpeta siempre escribible

  ######################################################################
  # TAREAS PRINCIPALES
  ######################################################################
  tasks:
  # 1. Validar sintaxis -------------------------------------------------
  - name: Validar sintaxis de Apache
    command: apachectl -t
    register: apache_syntax
    ignore_errors: true

  - name: Abortar si hay errores de sintaxis
    fail:
      msg: |
        ❌ Apache tiene errores de sintaxis:
        {{ apache_syntax.stderr | default(apache_syntax.stdout) }}
    when: apache_syntax.rc != 0

  - debug:
      msg: "✓ Sintaxis OK"

  # 2. Asegurar servicios ------------------------------------------------
  - name: Reiniciar y habilitar {{ apache_service_name }}
    service:
      name: "{{ apache_service_name }}"
      state: restarted
      enabled: yes

  - name: Reiniciar y habilitar PHP-FPM (si procede)
    service:
      name: "{{ php_fpm_service_name }}"
      state: restarted
      enabled: yes
    when: php_fpm_service_name | length > 0

  # 3. Descubrir DocumentRoot reales -----------------------------------
  - name: Extraer DocumentRoot desde la conf
    shell: >
      grep -REi '^[[:space:]]*DocumentRoot[[:space:]]+' {{ vhost_conf_paths | join(' ') }} 2>/dev/null |
      awk '{print $2}' | sort -u
    changed_when: false
    register: docroot_raw

  - name: Filtrar rutas dentro de /home/semaphore
    set_fact:
      docroots: "{{ docroot_raw.stdout_lines | select('search', '^/home/semaphore') | list }}"

  - debug:
      msg: "⚠️  No se encontraron DocumentRoot en /home/semaphore."
    when: docroots | length == 0

  # 4. Probar HTTP local -------------------------------------------------
  - name: curl localhost
    shell: curl -s -o /dev/null -w "%{http_code}\n" http://127.0.0.1/
    register: curl_root
    changed_when: false
    failed_when: false

  - debug:
      msg: "Código HTTP raíz: {{ curl_root.stdout }}"

  # 5. Guardar últimas líneas de los logs -------------------------------
  - name: Localizar error logs
    find:
      paths:
        - "/var/log/{{ apache_service_name }}"
        - "/var/log/apache2"
        - "/var/log/httpd"
      patterns: "{{ error_log_patterns }}"
      recurse: yes
    register: error_logs

  - name: Tail de {{ lines_to_fetch }} líneas por log
    shell: >
      tail -n {{ lines_to_fetch }} {{ item.path }} >
      /tmp/{{ inventory_hostname }}_{{ item.path | basename }}
    loop: "{{ error_logs.files }}"
    when: error_logs.matched > 0

  ######################################################################
  # 6. Copiar logs al nodo de control
  ######################################################################
  - name: Crear carpeta local para logs
    delegate_to: localhost
    become: false               # ← ¡¡importante!! mismo usuario que fetch
    run_once: true
    file:
      path: "{{ fetch_dest_root }}"
      state: directory
      mode: "0755"
    ignore_errors: true

  - name: Descargar logs al controlador
    fetch:
      src: "/tmp/{{ inventory_hostname }}_{{ item.path | basename }}"
      dest: "{{ fetch_dest_root }}/{{ inventory_hostname }}/"
      flat: yes
      delegate_to: localhost
    loop: "{{ error_logs.files }}"
    when: error_logs.matched > 0
    loop_control:
      label: "{{ item.path | basename }}"
    ignore_errors: true


  # 7. Resumen de permisos ----------------------------------------------
  - name: Obtener permisos/propietarios
    stat:
      path: "{{ item }}"
    loop: "{{ docroots }}"
    register: doc_stats
    failed_when: false

  - name: Mostrar permisos
    debug:
      msg: >
        {{ item.stat.path }}  →  owner={{ item.stat.pw_name }},
        group={{ item.stat.gr_name }}, mode={{ '%04o' % item.stat.mode }}
    loop: "{{ doc_stats.results }}"

  # 8. Conclusión --------------------------------------------------------
  - debug:
      msg: |
        ✅ Diagnóstico completo.
        Los logs están en «{{ fetch_dest_root }}/{{ inventory_hostname }}/».
        Revisa mensajes “PHP Fatal…”, “Permission denied…”, etc.
...
