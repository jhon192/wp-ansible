- name: Ver estado de Apache + últimos 200 logs
  hosts: localhost
  become: true
  gather_facts: true

  vars:
    ansible_remote_tmp: "/tmp/.ansible-123324453"
    ansible_connection: local

    apache_service_name: "{{ 'httpd' if ansible_os_family == 'RedHat' else 'apache2' }}"
    error_log_patterns: "*error*.log"
    lines_to_show: 200
    log_paths:
      - "/var/log/{{ apache_service_name }}"
      - "/var/log/apache2"
      - "/var/log/httpd"

  tasks:
    - name: Mostrar estado de {{ apache_service_name }}
      command: "systemctl status --no-pager {{ apache_service_name }}"
      register: apache_status
      changed_when: false

    - name: ⬇️  Salida de systemctl
      debug:
        var: apache_status.stdout_lines

    - name: Localizar archivos de error log
      find:
        paths: "{{ log_paths }}"
        patterns: "{{ error_log_patterns }}"
        recurse: yes
      register: error_logs

    - name: Aviso si no se hallaron logs
      debug:
        msg: "⚠️  No se encontró ningún archivo de error log para Apache."
      when: error_logs.matched == 0

    - name: Mostrar últimos {{ lines_to_show }} renglones de cada log
      shell: "tail -n {{ lines_to_show }} {{ item.path }}"
      loop: "{{ error_logs.files }}"
      register: log_tails
      changed_when: false
      when: error_logs.matched > 0
      loop_control:
        label: "{{ item.path | basename }}"

    - name: ⬇️  Contenido de los logs
      debug:
        msg: |
          ---- {{ item.item.path }} ----
          {{ item.stdout }}
      loop: "{{ log_tails.results }}"
      when: error_logs.matched > 0
...
