---
- name: Diagnóstico de sintaxis Apache
  hosts: localhost          # o el grupo/host que corresponda
  become: true
  vars:
    ansible_remote_tmp: "/tmp/.ansible-123324453"
  tasks:

    - name: Backup de apache2.conf antes de tocarlo
      copy:
        src: /etc/apache2/apache2.conf
        dest: /etc/apache2/apache2.conf.bak
        owner: root
        group: root
        mode: '0644'
        backup: yes

    - name: Borrar la línea suelta 'Require all granted'
      lineinfile:
        path: /etc/apache2/apache2.conf
        regexp: '^\s*Require\s+all\s+granted\s*$'
        state: absent

    - name: Ejecutar apachectl configtest otra vez
      shell: apachectl configtest
      register: configtest

    - name: Mostrar resultado del configtest
      debug:
        var: configtest.stdout_lines

    - name: Fallar si sigue habiendo errores
      fail:
        msg: "Apache aún tiene errores: {{ configtest.stdout }}"
      when: "'Syntax OK' not in configtest.stdout"

    - name: Recargar Apache si la sintaxis es correcta
      service:
        name: apache2
        state: reloaded
      when: "'Syntax OK' in configtest.stdout"
