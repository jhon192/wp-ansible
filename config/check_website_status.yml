---
- name: Eliminar líneas duplicadas con APACHE_LOG_DIR en vhosts
  hosts: localhost
  become: yes

  vars:
    vhost_dir: "/etc/apache2/sites-available"
    ansible_remote_tmp: "/tmp/.ansible-123324453"


  tasks:

    - name: Encontrar archivos *.conf de VirtualHosts
      find:
        paths: "{{ vhost_dir }}"
        patterns: "*.conf"
      register: vhost_files

    - name: Eliminar líneas con APACHE_LOG_DIR (logs duplicados)
      lineinfile:
        path: "{{ item.path }}"
        regexp: '^\s*(ErrorLog|CustomLog)\s+\$\{APACHE_LOG_DIR\}/.*'
        state: absent
      loop: "{{ vhost_files.files }}"

  handlers:
    - name: restart apache
      service:
        name: apache2
        state: restarted
